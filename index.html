<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœºæ¢°è‡‚æ•°å­—å­ªç”Ÿç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .status-bar {
            display: flex;
            justify-content: space-around;
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .status-item {
            text-align: center;
        }
        
        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4facfe;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid #e1e5e9;
        }
        
        .panel h2 {
            color: #4facfe;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4facfe;
        }
        
        .joint-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .joint {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .joint:hover {
            transform: translateY(-5px);
            background: #e9ecef;
        }
        
        .joint-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ff6b6b;
        }
        
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }
        
        .btn-start {
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }
        
        .btn-stop {
            background: linear-gradient(90deg, #ff6b6b 0%, #ff8e8e 100%);
            color: white;
        }
        
        .btn-reset {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #camera-feed {
            width: 100%;
            height: 400px;
            background: #2c3e50;
            border-radius: 10px;
            overflow: hidden;
        }
        
        #camera-feed img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
        
        .log-panel {
            height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            color: #6c757d;
            border-top: 1px solid #e9ecef;
        }
        
        .connection-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .connected {
            background: #43e97b;
            box-shadow: 0 0 10px #43e97b;
        }
        
        .disconnected {
            background: #ff6b6b;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¤– æœºæ¢°è‡‚æ•°å­—å­ªç”Ÿç³»ç»Ÿ</h1>
            <p>ROS + MATLAB + DQN | å®æ—¶ç›‘æ§ä¸æ§åˆ¶</p>
        </header>
        
        <div class="status-bar">
            <div class="status-item">
                <div>ç³»ç»ŸçŠ¶æ€</div>
                <div class="status-value" id="system-mode">IDLE</div>
            </div>
            <div class="status-item">
                <div>å¥–åŠ±å€¼</div>
                <div class="status-value" id="reward-value">0.00</div>
            </div>
            <div class="status-item">
                <div>è¿æ¥çŠ¶æ€</div>
                <div>
                    <span class="connection-status" id="conn-status"></span>
                    <span id="conn-text">è¿æ¥ä¸­...</span>
                </div>
            </div>
            <div class="status-item">
                <div>æ›´æ–°æ—¶é—´</div>
                <div class="status-value" id="update-time">--:--:--</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="panel">
                <h2>ğŸ”§ å…³èŠ‚çŠ¶æ€</h2>
                <div class="joint-display" id="joints-container">
                    <!-- å…³èŠ‚ä¼šé€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <h2>ğŸ® æ§åˆ¶é¢æ¿</h2>
                <div class="control-panel">
                    <button class="btn btn-start" onclick="sendCommand('start')">
                        â–¶ï¸ å¯åŠ¨DQN
                    </button>
                    <button class="btn btn-stop" onclick="sendCommand('stop')">
                        â¸ï¸ æš‚åœ
                    </button>
                    <button class="btn btn-reset" onclick="sendCommand('reset')">
                        ğŸ”„ é‡ç½®
                    </button>
                    <button class="btn" onclick="sendCommand('home')" 
                            style="background: linear-gradient(90deg, #ff9a9e 0%, #fad0c4 100%);">
                        ğŸ  å›é›¶
                    </button>
                </div>
                
                <h2>ğŸ“ˆ å¥–åŠ±æ›²çº¿</h2>
                <div class="chart-container">
                    <canvas id="reward-chart"></canvas>
                </div>
            </div>
            
            <div class="panel">
                <h2>ğŸ‘ï¸ å®æ—¶å›¾åƒ</h2>
                <div id="camera-feed">
                    <img id="robot-image" src="" alt="æœºæ¢°è‡‚å®æ—¶å›¾åƒ">
                </div>
                
                <h2>ğŸ“Š ä½ç½®ä¿¡æ¯</h2>
                <div id="position-info" style="margin-bottom: 20px;">
                    <div>æœ«ç«¯ä½ç½®: <span id="end-effector">[0.00, 0.00, 0.00]</span></div>
                    <div>ç›®æ ‡ä½ç½®: <span id="target-position">[0.00, 0.00, 0.00]</span></div>
                </div>
                
                <h2>ğŸ“ ç³»ç»Ÿæ—¥å¿—</h2>
                <div class="log-panel" id="log-container">
                    <!-- æ—¥å¿—ä¼šåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        </div>
        
        <footer>
            <p>æ ‘è“æ´¾ROS + MATLAB DQN | æ•°å­—å­ªç”Ÿç›‘æ§ç³»ç»Ÿ | Â© 2023</p>
            <p id="backend-url">åç«¯åœ°å€: æœªè®¾ç½®</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ============ é…ç½®éƒ¨åˆ† ============
        // !!! é‡è¦ï¼šä¿®æ”¹ä¸ºæ‚¨çš„Windowsç”µè„‘å±€åŸŸç½‘IP !!!
        const BACKEND_IP = "192.168.110.19"; // æ”¹ä¸ºæ‚¨å®é™…çš„IP
        const BACKEND_PORT = "8000";
        const BACKEND_URL = `http://${BACKEND_IP}:${BACKEND_PORT}`;
        
        document.getElementById('backend-url').textContent = `åç«¯åœ°å€: ${BACKEND_URL}`;
        
        // ============ çŠ¶æ€å˜é‡ ============
        let connectionOk = false;
        let rewardHistory = [];
        let logEntries = [];
        let chart = null;
        
        // ============ DOM å…ƒç´  ============
        const jointsContainer = document.getElementById('joints-container');
        const modeElement = document.getElementById('system-mode');
        const rewardElement = document.getElementById('reward-value');
        const connStatus = document.getElementById('conn-status');
        const connText = document.getElementById('conn-text');
        const updateTime = document.getElementById('update-time');
        const robotImage = document.getElementById('robot-image');
        const endEffector = document.getElementById('end-effector');
        const targetPosition = document.getElementById('target-position');
        const logContainer = document.getElementById('log-container');
        
        // ============ åˆå§‹åŒ– ============
        function init() {
            log("ç³»ç»Ÿåˆå§‹åŒ–...");
            log(`è¿æ¥åˆ°åç«¯: ${BACKEND_URL}`);
            
            // åˆå§‹åŒ–å…³èŠ‚æ˜¾ç¤º
            for (let i = 1; i <= 6; i++) {
                const jointDiv = document.createElement('div');
                jointDiv.className = 'joint';
                jointDiv.innerHTML = `
                    <div>å…³èŠ‚ ${i}</div>
                    <div class="joint-value" id="joint-${i}">0.00Â°</div>
                    <div style="font-size: 0.9rem; color: #666;">ç›®æ ‡: <span id="target-${i}">0.00Â°</span></div>
                `;
                jointsContainer.appendChild(jointDiv);
            }
            
            // åˆå§‹åŒ–å›¾è¡¨
            initChart();
            
            // å¼€å§‹æ•°æ®æ›´æ–°å¾ªç¯
            setInterval(fetchState, 500);  // æ¯500msæ›´æ–°ä¸€æ¬¡çŠ¶æ€
            setInterval(updateImage, 300); // æ¯300msæ›´æ–°å›¾åƒ
            
            // åˆå§‹è¿æ¥æµ‹è¯•
            testConnection();
        }
        
        // ============ å›¾è¡¨åˆå§‹åŒ– ============
        function initChart() {
            const ctx = document.getElementById('reward-chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'DQNå¥–åŠ±å€¼',
                        data: [],
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        // ============ è¿æ¥æµ‹è¯• ============
        async function testConnection() {
            try {
                const response = await fetch(`${BACKEND_URL}/state`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    connectionOk = true;
                    connStatus.className = 'connection-status connected';
                    connText.textContent = 'å·²è¿æ¥';
                    log('åç«¯è¿æ¥æˆåŠŸ');
                } else {
                    connectionOk = false;
                    connStatus.className = 'connection-status disconnected';
                    connText.textContent = 'è¿æ¥å¤±è´¥';
                }
            } catch (error) {
                connectionOk = false;
                connStatus.className = 'connection-status disconnected';
                connText.textContent = 'è¿æ¥é”™è¯¯';
                log(`è¿æ¥é”™è¯¯: ${error.message}`);
            }
        }
        
        // ============ è·å–çŠ¶æ€æ•°æ® ============
        async function fetchState() {
            if (!connectionOk) {
                await testConnection();
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/state`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateDisplay(data);
                }
            } catch (error) {
                connectionOk = false;
                connStatus.className = 'connection-status disconnected';
                connText.textContent = 'è¿æ¥ä¸¢å¤±';
            }
        }
        
        // ============ æ›´æ–°æ˜¾ç¤º ============
        function updateDisplay(data) {
            // æ›´æ–°æ¨¡å¼
            modeElement.textContent = data.mode.toUpperCase();
            
            // æ›´æ–°å¥–åŠ±å€¼
            const reward = data.reward || 0;
            rewardElement.textContent = reward.toFixed(2);
            
            // æ›´æ–°å…³èŠ‚è§’åº¦
            if (data.joints && data.joints.length >= 6) {
                for (let i = 0; i < 6; i++) {
                    const jointElement = document.getElementById(`joint-${i+1}`);
                    if (jointElement) {
                        jointElement.textContent = `${data.joints[i].toFixed(2)}Â°`;
                    }
                }
            }
            
            // æ›´æ–°ä½ç½®ä¿¡æ¯
            if (data.position) {
                endEffector.textContent = `[${data.position[0].toFixed(2)}, ${data.position[1].toFixed(2)}, ${data.position[2].toFixed(2)}]`;
            }
            
            if (data.target) {
                targetPosition.textContent = `[${data.target[0].toFixed(2)}, ${data.target[1].toFixed(2)}, ${data.target[2].toFixed(2)}]`;
                for (let i = 0; i < 6; i++) {
                    const targetElement = document.getElementById(`target-${i+1}`);
                    if (targetElement && data.target[i] !== undefined) {
                        targetElement.textContent = `${data.target[i].toFixed(2)}Â°`;
                    }
                }
            }
            
            // æ›´æ–°æ—¶é—´
            const now = new Date();
            updateTime.textContent = now.toLocaleTimeString();
            
            // æ›´æ–°å¥–åŠ±å›¾è¡¨
            updateChart(reward);
        }
        
        // ============ æ›´æ–°å›¾è¡¨ ============
        function updateChart(reward) {
            rewardHistory.push(reward);
            if (rewardHistory.length > 50) {
                rewardHistory = rewardHistory.slice(-50);
            }
            
            chart.data.labels = Array.from({length: rewardHistory.length}, (_, i) => i+1);
            chart.data.datasets[0].data = rewardHistory;
            chart.update();
        }
        
        // ============ æ›´æ–°å›¾åƒ ============
        function updateImage() {
            if (!connectionOk) return;
            
            // ä½¿ç”¨æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
            const timestamp = new Date().getTime();
            robotImage.src = `${BACKEND_URL}/image?t=${timestamp}`;
            
            // å›¾åƒåŠ è½½å¤±è´¥å¤„ç†
            robotImage.onerror = function() {
                this.src = 'https://via.placeholder.com/640x400/2c3e50/ecf0f1?text=ç­‰å¾…å›¾åƒ...';
            };
        }
        
        // ============ å‘é€æ§åˆ¶å‘½ä»¤ ============
        async function sendCommand(action, jointValues = null, speed = 1.0) {
            if (!connectionOk) {
                log("é”™è¯¯ï¼šæœªè¿æ¥åˆ°åç«¯");
                return;
            }
            
            const command = {
                action: action,
                joint_values: jointValues,
                speed: speed
            };
            
            log(`å‘é€å‘½ä»¤: ${action}`);
            
            try {
                const response = await fetch(`${BACKEND_URL}/command`, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(command)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`å‘½ä»¤æ‰§è¡ŒæˆåŠŸ: ${action}`);
                    return result;
                } else {
                    log(`å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${action}`);
                }
            } catch (error) {
                log(`å‘é€å‘½ä»¤é”™è¯¯: ${error.message}`);
            }
        }
        
        // ============ æ—¥å¿—åŠŸèƒ½ ============
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                time: timestamp,
                message: message
            };
            
            logEntries.unshift(logEntry);
            if (logEntries.length > 20) {
                logEntries = logEntries.slice(0, 20);
            }
            
            // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
            logContainer.innerHTML = '';
            logEntries.forEach(entry => {
                const div = document.createElement('div');
                div.className = 'log-entry';
                div.innerHTML = `<span style="color: #666;">[${entry.time}]</span> ${entry.message}`;
                logContainer.appendChild(div);
            });
            
            // æ§åˆ¶å°ä¹Ÿè¾“å‡º
            console.log(`[${timestamp}] ${message}`);
        }
        
        // ============ å·¥å…·å‡½æ•° ============
        function setJointAngles() {
            const angles = [];
            for (let i = 1; i <= 6; i++) {
                const angle = prompt(`è¾“å…¥å…³èŠ‚ ${i} è§’åº¦ (åº¦):`, "0");
                if (angle !== null) {
                    angles.push(parseFloat(angle));
                }
            }
            
            if (angles.length === 6) {
                sendCommand('move', angles, 1.0);
            }
        }
        
        // ============ é¡µé¢åŠ è½½å®Œæˆ ============
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
