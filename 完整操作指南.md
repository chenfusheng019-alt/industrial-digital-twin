# 🎯 机械臂数字孪生系统 - 完整操作指南

## 📋 系统概述

本系统实现了从机械臂到网页的完整数据传输链路：

```
机械臂(ROS) → MATLAB(DQN) → 后端服务器 → GitHub网站
```

**网站地址**: https://chenfusheng019-alt.github.io/industrial-digital-twin/index.html

## ✅ 已实现的功能

1. ✅ **实时数据传输**: MATLAB 自动推送数据到后端
2. ✅ **WebSocket 通信**: 后端实时广播数据到网页
3. ✅ **关节状态显示**: 显示 6 个关节的实时角度
4. ✅ **奖励曲线绘制**: 实时绘制 DQN 训练奖励曲线
5. ✅ **图像传输**: 支持机械臂图像实时传输
6. ✅ **连接状态监控**: 显示系统连接状态

## 🚀 启动步骤（按顺序执行）

### 第一步：启动后端服务器 ⭐

**方法 1：使用批处理脚本（推荐）**

1. 双击运行：`d:\matlab\代码\启动服务器.bat`
2. 记下显示的本机 IP 地址（例如：192.168.1.105）

**方法 2：手动启动**

```powershell
cd d:\matlab\代码
python server.py
```

**成功标志**：
```
🚀 启动机械臂数字孪生后端服务器
📡 HTTP API: http://0.0.0.0:8000
🔌 WebSocket: ws://0.0.0.0:8000/ws
```

---

### 第二步：配置 IP 地址 ⭐⭐

**获取您的局域网 IP**：
- Windows: 运行 `ipconfig`，查找 "IPv4 地址"
- 例如：192.168.1.105

**需要修改的文件**：

#### 1. `DQN_MATLAB/push_to_backend.m` (第 2 行)

```matlab
url = 'http://192.168.1.105:8000/update';  % 改为您的实际IP
```

#### 2. `Github/index.html` (第 265 行左右)

```javascript
const BACKEND_IP = "192.168.1.105";  // 改为您的实际IP
```

---

### 第三步：测试连接 ⭐

在 MATLAB 中运行测试脚本：

```matlab
cd('d:\matlab\代码\DQN_MATLAB')
test_backend_connection
```

**期望输出**：
```
🎉 所有测试通过！系统运行正常。
总计: 5/5 测试通过
```

如果测试失败，请检查：
- 后端服务器是否正在运行
- IP 地址配置是否正确
- 防火墙是否允许端口 8000

---

### 第四步：启动 MATLAB 控制程序 ⭐⭐⭐

```matlab
cd('d:\matlab\代码\DQN_MATLAB')
receive_and_control
```

**成功标志**：
- MATLAB 显示 "Python环境配置成功"
- ROS 连接成功
- 开始接收数据

**后端服务器应该显示**：
```
📊 状态更新: Episode 1, Step 10, 模式: training, 奖励: 0.850
```

---

### 第五步：打开网页监控 ⭐⭐⭐

#### 方案 A：本地测试（推荐先用这个）

1. 双击打开：`d:\matlab\代码\Github\index.html`
2. 或在浏览器地址栏输入：
   ```
   file:///d:/matlab/代码/Github/index.html
   ```

#### 方案 B：GitHub Pages（公网访问）

1. 将 `Github` 文件夹内容上传到 GitHub 仓库
2. 访问：https://chenfusheng019-alt.github.io/industrial-digital-twin/index.html

**注意**：GitHub Pages 需要能访问您的局域网 IP，建议使用内网穿透（见下文）。

---

## 🔍 验证系统运行

### 1. 检查后端服务器

在浏览器访问：`http://localhost:8000`

应该看到 API 信息。

### 2. 检查网页连接

打开网页后，应该看到：
- ✅ 左上角显示 "已连接"（绿色指示灯）
- ✅ 系统日志显示 "✅ WebSocket 连接成功"

### 3. 检查数据传输

网页应该实时显示：
- ✅ 关节角度在变化
- ✅ 奖励值在更新
- ✅ 奖励曲线在绘制
- ✅ 更新时间在刷新

---

## 🌐 部署到 GitHub Pages（公网访问）

### 问题：GitHub Pages 无法访问局域网 IP

GitHub Pages 托管在公网，无法直接访问您的局域网 IP（192.168.x.x）。

### 解决方案：使用内网穿透

#### 方法 1：使用 ngrok（推荐）

1. **下载 ngrok**：https://ngrok.com/download

2. **启动内网穿透**：
   ```powershell
   ngrok http 8000
   ```

3. **获取公网地址**（例如）：
   ```
   Forwarding: https://abc123.ngrok.io -> http://localhost:8000
   ```

4. **修改 `Github/index.html`**：
   ```javascript
   const BACKEND_IP = "abc123.ngrok.io";
   const BACKEND_PORT = "443";
   const BACKEND_URL = `https://${BACKEND_IP}`;
   const WEBSOCKET_URL = `wss://${BACKEND_IP}/ws`;
   ```

5. **上传到 GitHub**：
   - 将修改后的 `index.html` 上传到 GitHub 仓库
   - 访问 GitHub Pages 网址

#### 方法 2：使用 frp

1. 下载 frp：https://github.com/fatedier/frp
2. 配置 frp 客户端
3. 映射本地 8000 端口到公网

#### 方法 3：使用云服务器

1. 将 `server.py` 部署到云服务器（阿里云、腾讯云等）
2. 修改 MATLAB 和网页中的 IP 为云服务器公网 IP

---

## 📊 完整运行流程

```
1. 启动后端服务器
   ↓
2. 配置 IP 地址
   ↓
3. 测试连接
   ↓
4. 启动 ROS 节点（在机械臂端）
   ↓
5. 启动 MATLAB 控制程序
   ↓
6. 打开网页监控
   ↓
7. 观察实时数据传输
```

---

## 🐛 常见问题与解决

### 问题 1：WebSocket 连接失败

**症状**：网页显示 "连接错误" 或 "连接断开"

**解决方法**：
1. 检查后端服务器是否正在运行
2. 检查 `index.html` 中的 IP 地址是否正确
3. 按 F12 打开浏览器控制台，查看错误信息
4. 检查防火墙设置：
   ```powershell
   # 允许端口 8000
   netsh advfirewall firewall add rule name="Digital Twin" dir=in action=allow protocol=TCP localport=8000
   ```

### 问题 2：MATLAB 推送数据失败

**症状**：MATLAB 显示 "推送失败" 或后端无数据

**解决方法**：
1. 检查 `push_to_backend.m` 中的 URL 配置
2. 在 MATLAB 中测试连接：
   ```matlab
   webread('http://192.168.1.105:8000/health')
   ```
3. 查看后端服务器日志

### 问题 3：网页数据不更新

**症状**：网页显示 "已连接" 但数据不变化

**解决方法**：
1. 确保 MATLAB 程序正在运行
2. 检查 MATLAB 是否在推送数据（查看后端日志）
3. 刷新网页（Ctrl + F5）

### 问题 4：GitHub Pages 无法连接

**症状**：GitHub Pages 网站显示 "连接错误"

**原因**：GitHub Pages 在公网，无法访问局域网 IP

**解决方法**：
- 使用内网穿透（ngrok、frp）
- 或将后端部署到云服务器

### 问题 5：Python 依赖安装失败

**解决方法**：
```powershell
# 使用国内镜像源
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple fastapi uvicorn pillow websockets
```

---

## 📁 文件清单

### 核心文件（必需）

- ✅ `server.py` - 后端服务器
- ✅ `DQN_MATLAB/receive_and_control.m` - MATLAB 主程序
- ✅ `DQN_MATLAB/rl_data_callback.m` - ROS 回调函数
- ✅ `DQN_MATLAB/push_to_backend.m` - 数据推送函数
- ✅ `DQN_MATLAB/push_image_to_backend.m` - 图像推送函数
- ✅ `Github/index.html` - 网页界面

### 辅助文件（可选）

- `DQN_MATLAB/test_backend_connection.m` - 连接测试
- `DQN_MATLAB/test_end_to_end.m` - 端到端测试
- `DQN_MATLAB/plot_reward.m` - 奖励曲线绘制
- `启动服务器.bat` - 快速启动脚本

### 多余文件（可删除）

- `DQN_MATLAB/untitled4.m` - 功能重复
- `DQN_MATLAB/test_python_env.m` - 仅用于诊断

---

## 🎯 操作检查清单

在启动系统前，请确认：

- [ ] Python 已安装（3.8+）
- [ ] 已安装依赖包（fastapi, uvicorn, pillow, websockets）
- [ ] 后端服务器正在运行
- [ ] 已获取本机局域网 IP 地址
- [ ] 已修改 `push_to_backend.m` 中的 IP
- [ ] 已修改 `index.html` 中的 IP
- [ ] 已运行 `test_backend_connection.m` 测试
- [ ] ROS 节点正在运行（机械臂端）
- [ ] MATLAB 程序正在运行
- [ ] 网页已打开并显示 "已连接"

---

## 📞 技术支持

如遇到问题，请按以下顺序检查：

1. **后端服务器日志** - 查看是否有错误信息
2. **MATLAB 命令窗口** - 查看推送是否成功
3. **浏览器控制台（F12）** - 查看 WebSocket 连接状态
4. **网络连接** - 确保设备在同一局域网

---

## 🎉 成功标志

当系统正常运行时，您应该看到：

1. ✅ 后端服务器持续打印：`📊 状态更新: Episode X, Step Y, 奖励: Z`
2. ✅ 网页左上角显示 "已连接"（绿色）
3. ✅ 关节角度实时变化
4. ✅ 奖励曲线实时绘制
5. ✅ 更新时间持续刷新

---

**祝您使用愉快！** 🚀

如有问题，请查看详细文档：`DQN_MATLAB/启动指南.md`
